package controllers

import (
	"encoding/base64"
	"encoding/pem"
	"github.com/stretchr/testify/require"
	"os"
	"testing"
)

const PrivateKey = `-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAsnikDSKWoi4e6raCHbkCMm4sy4Wx4rqRgZYzmSQmoRIaLG4M
+l1oieNcl9SCcAw00gVQTt7V/K4mQDBjwSNcDyvQP2fxk0GcwllRNi+IRwV3LQ8c
MoXGfeEj28lYKWZruZsFQ6/XF6iCVe6rQqL7LgJj8hI48+OC6QO3vPJ0pYrGpmeC
eOQVUYT9+tBs/tc0rPAVHt8SSl7iH1QxmaZ0OFv79K42GbR7VVbCJF/zb/365tKt
PD7HnakJ4eiJkzIXLZBs7j9VhqRHNkjpCe+S/MeWTgKveRK00Mgd8oF7h/n0TDS3
7En8FYjG05cnOEUoS5CH13OtKQ4cC43lHc7fxwIDAQABAoIBAChFWJ8uItdNmORV
cl7KlFhUy/7QmCcU+ihHgDUaFy1ZLFbCLmOAGEqk5wvLg/NMjc6mLEzfs2Fk2nS5
dojqNaemt0LXbYdQ0tJ33P9hElsUPKQKOM6dqQBWgQTjFeWhmsUy2alAUESiXWaO
iE5tAEiNeYfx3LALskpp8FfOTcvcd8N/4/1JjJ6AiocXNHXDejDXZYO7bKWffFqo
unpXZgN3e/vdfGuwKbq077oilvd65vDdB6sDpZ3TZlk+EpV1YEIL+pGdj63tmK4P
faH6zS60nQqB7fMwurJF4T1QnXv5VHO8WEwimQbhfpl11CTC4qx4AyzVuIzqAkyH
HajP9KECgYEAw1EIV53FwRocCnPljEBTFxCuiUcJUzm+du7QAMWw2G3/ulkJuFvR
iG+KhMmw54lvbpQ3iZQZ4krx19LN9j9FyEjCCBfQgyqDMkHtnFAgQ8rgESO3b7BO
HgatAR1T+mb06Lc77y82kjXYglvra5esFF6/VivAmxTTFiDsmFSI/TsCgYEA6evH
UjxzZgL4nhWr31ewFlWHcXnIlUq4ns81OzsaO7KVUu46Dl/60F0hcEQAHRtb0ZJz
Yh2G3fUlxv6duqrToItElcQ4GHHrXx9JKamHlfAFXoqhzEN+V3KAJmcLqgrzcxXS
1k1m+PpxXffEbP0yHqtVdXJ8wh/RyKjkSqQPbuUCgYEAjGfMH3ADoPUsAzedZF05
XfNYBMdUJMf163lxfZyfrHYmx8cJ/cXDsti8MwjqaweZW1yhL/2PPeWyRPv9o2+I
spnbIgY8lo4REifir+PJzfIhcTDDxT5waZVS+OIkZHVuyXwvUZoXGLQsmEmLyySV
R291DHUXWGR3+ghhDIB4mdECgYEApG1Cv3CUoUlHXz/Wf3jQ4vId8crsDtzmJ2N5
hHgH+ZyPUCr6ji4zTJGaNqLl/Y/Em+y4xGgC7DQs6NMDJjp75abff/Lch3pUO5nv
QKTVFLUR4SHLl5x9y5RFtjjKvy1RcT0O5eqkjjDkzWujHAViXKKMwLDIN2BMgyMM
zdbCrm0CgYAjzsiru3otxrj2vRX6+geivbihHEt7QE/7iuN+J13BoLpKX+CGJxy5
pvVG1bkyaUTZD1u/GQpVSkF3BAPqPAJQKds9sORrSH3SC25v5g+Ad+S9NtWJNTBy
1eUhVypquoanZnnbD9DQxyTatNTQCvVajp3Z4i0IY8Yz7/Mizf1zqQ==
-----END RSA PRIVATE KEY-----
`

const secret = "Jq+KMkLuyiornnL79RvGO0j0dVS2U3gEXIhheZea1+PfJIl0Ja1NlNb/dYTCKdFqrmdyQ0kZtfli+s3hcf7KhtfU6peVdgpo73t6YslKMsBVhmQWFYPDtRRpeyuEV2RUlasfiEoXo+wHRV+5+DQrDW+0kVEsCQvMHw2+dDM0HMDujSAb11VhTQoebyMdsMYxarttgGdZo6KoXmFfxxEEL0g93vzHfkdyGUXUFNkXmkh2anJO1DOfcA1Uq60APy4Oth/z0Ms9+h7VLP2XS9Zvoru1o8Q0SdFtQX8F0/NlpZKQYyuqtJ2BpLix/WUuyROkH/JyzI10ChE3AZErBD8i7w=="

func TestDecryptSecret(t *testing.T) {
	expectedOutput := "This is my secret"

	os.Setenv("RSA_PRIVATE_KEY", base64.StdEncoding.EncodeToString([]byte(PrivateKey)))

	output, err := decryptSecret("rsa:" + secret)

	require.NoError(t, err)
	require.Equal(t, output, expectedOutput)
}

func TestDecryptPrivatePEM(t *testing.T) {
	input := "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBc25pa0RTS1dvaTRlNnJhQ0hia0NNbTRzeTRXeDRycVJnWll6bVNRbW9SSWFMRzRNCitsMW9pZU5jbDlTQ2NBdzAwZ1ZRVHQ3Vi9LNG1RREJqd1NOY0R5dlFQMmZ4azBHY3dsbFJOaStJUndWM0xROGMKTW9YR2ZlRWoyOGxZS1dacnVac0ZRNi9YRjZpQ1ZlNnJRcUw3TGdKajhoSTQ4K09DNlFPM3ZQSjBwWXJHcG1lQwplT1FWVVlUOSt0QnMvdGMwclBBVkh0OFNTbDdpSDFReG1hWjBPRnY3OUs0MkdiUjdWVmJDSkYvemIvMzY1dEt0ClBEN0huYWtKNGVpSmt6SVhMWkJzN2o5VmhxUkhOa2pwQ2UrUy9NZVdUZ0t2ZVJLMDBNZ2Q4b0Y3aC9uMFREUzMKN0VuOEZZakcwNWNuT0VVb1M1Q0gxM090S1E0Y0M0M2xIYzdmeHdJREFRQUJBb0lCQUNoRldKOHVJdGRObU9SVgpjbDdLbEZoVXkvN1FtQ2NVK2loSGdEVWFGeTFaTEZiQ0xtT0FHRXFrNXd2TGcvTk1qYzZtTEV6ZnMyRmsyblM1CmRvanFOYWVtdDBMWGJZZFEwdEozM1A5aEVsc1VQS1FLT002ZHFRQldnUVRqRmVXaG1zVXkyYWxBVUVTaVhXYU8KaUU1dEFFaU5lWWZ4M0xBTHNrcHA4RmZPVGN2Y2Q4Ti80LzFKako2QWlvY1hOSFhEZWpEWFpZTzdiS1dmZkZxbwp1bnBYWmdOM2UvdmRmR3V3S2JxMDc3b2lsdmQ2NXZEZEI2c0RwWjNUWmxrK0VwVjFZRUlMK3BHZGo2M3RtSzRQCmZhSDZ6UzYwblFxQjdmTXd1ckpGNFQxUW5YdjVWSE84V0V3aW1RYmhmcGwxMUNUQzRxeDRBeXpWdUl6cUFreUgKSGFqUDlLRUNnWUVBdzFFSVY1M0Z3Um9jQ25QbGpFQlRGeEN1aVVjSlV6bStkdTdRQU1XdzJHMy91bGtKdUZ2UgppRytLaE1tdzU0bHZicFEzaVpRWjRrcngxOUxOOWo5RnlFakNDQmZRZ3lxRE1rSHRuRkFnUThyZ0VTTzNiN0JPCkhnYXRBUjFUK21iMDZMYzc3eTgya2pYWWdsdnJhNWVzRkY2L1ZpdkFteFRURmlEc21GU0kvVHNDZ1lFQTZldkgKVWp4elpnTDRuaFdyMzFld0ZsV0hjWG5JbFVxNG5zODFPenNhTzdLVlV1NDZEbC82MEYwaGNFUUFIUnRiMFpKegpZaDJHM2ZVbHh2NmR1cXJUb0l0RWxjUTRHSEhyWHg5SkthbUhsZkFGWG9xaHpFTitWM0tBSm1jTHFncnpjeFhTCjFrMW0rUHB4WGZmRWJQMHlIcXRWZFhKOHdoL1J5S2prU3FRUGJ1VUNnWUVBakdmTUgzQURvUFVzQXplZFpGMDUKWGZOWUJNZFVKTWYxNjNseGZaeWZySFlteDhjSi9jWERzdGk4TXdqcWF3ZVpXMXloTC8yUFBlV3lSUHY5bzIrSQpzcG5iSWdZOGxvNFJFaWZpcitQSnpmSWhjVEREeFQ1d2FaVlMrT0lrWkhWdXlYd3ZVWm9YR0xRc21FbUx5eVNWClIyOTFESFVYV0dSMytnaGhESUI0bWRFQ2dZRUFwRzFDdjNDVW9VbEhYei9XZjNqUTR2SWQ4Y3JzRHR6bUoyTjUKaEhnSCtaeVBVQ3I2amk0elRKR2FOcUxsL1kvRW0reTR4R2dDN0RRczZOTURKanA3NWFiZmYvTGNoM3BVTzVudgpRS1RWRkxVUjRTSExsNXg5eTVSRnRqakt2eTFSY1QwTzVlcWtqakRreld1akhBVmlYS0tNd0xESU4yQk1neU1NCnpkYkNybTBDZ1lBanpzaXJ1M290eHJqMnZSWDYrZ2VpdmJpaEhFdDdRRS83aXVOK0oxM0JvTHBLWCtDR0p4eTUKcHZWRzFia3lhVVRaRDF1L0dRcFZTa0YzQkFQcVBBSlFLZHM5c09SclNIM1NDMjV2NWcrQWQrUzlOdFdKTlRCeQoxZVVoVnlwcXVvYW5abm5iRDlEUXh5VGF0TlRRQ3ZWYWpwM1o0aTBJWThZejcvTWl6ZjF6cVE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo="
	expected := PrivateKey

	decodedPem, err := decodePem(input)

	require.NoError(t, err)
	output := string(pem.EncodeToMemory(decodedPem))

	require.Equal(t, expected, output)
}

func TestDecryptPrivatePEMFail(t *testing.T) {
	input := "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBc25pa0RTS1dvaTRlNnJhQ0hia0NNbTRzeTRXeDRycVJnWll6bVNRbW9SSWFMRzRNCitsMW9pZU5jbDlTQ2NBdzAwZ1ZRVHQ3Vi9LNG1RREJqd1NOY0R5dlFQMmZ4azBHY3dsbFJOaStJUndWM0xROGMKTW9YR2ZlRWoyOGxZS1dacnVac0ZRNi9YRjZpQ1ZlNnJRcUw3TGdKajhoSTQ4K09DNlFPM3ZQSjBwWXJHcG1lQwplT1FWVVlUOSt0QnMvdGMwclBBVkh0OFNTbDdpSDFReG1hWjBPRnY3OUs0MkdiUjdWVmJDSkYvemIvMzY1dEt0ClBEN0huYWtKNGVpSmt6SVhMWkJzN2o5VmhxUkhOa2pwQ2UrUy9NZVdUZ0t2ZVJLMDBNZ2Q4b0Y3aC9uMFREUzMKN0VuOEZZakcwNWNuT0VVb1M1Q0gxM090S1E0Y0M0M2xIYzdmeHdJREFRQUJBb0lCQUNoRldKOHVJdGRObU9SVgpjbDdLbEZoVXkvN1FtQ2NVK2loSGdEVWFGeTFaTEZiQ0xtT0FHRXFrNXd2TGcvTk1qYzZtTEV6ZnMyRmsyblM1CmRvanFOYWVtdDBMWGJZZFEwdEozM1A5aEVsc1VQS1FLT002ZHFRQldnUVRqRmVXaG1zVXkyYWxBVUVTaVhXYU8KaUU1dEFFaU5lWWZ4M0xBTHNrcHA4RmZPVGN2Y2Q4Ti80LzFKako2QWlvY1hOSFhEZWpEWFpZTzdiS1dmZkZxbwp1bnBYWmdOM2UvdmRmR3V3S2JxMDc3b2lsdmQ2NXZEZEI2c0RwWjNUWmxrK0VwVjFZRUlMK3BHZGo2M3RtSzRQCmZhSDZ6UzYwblFxQjdmTXd1ckpGNFQxUW5YdjVWSE84V0V3aW1RYmhmcGwxMUNUQzRxeDRBeXpWdUl6cUFreUgKSGFqUDlLRUNnWUVBdzFFSVY1M0Z3Um9jQ25QbGpFQlRGeEN1aVVjSlV6bStkdTdRQU1XdzJHMy91bGtKdUZ2UgppRytLaE1tdzU0bHZicFEzaVpRWjRrcngxOUxOOWo5RnlFakNDQmZRZ3lxRE1rSHRuRkFnUThyZ0VTTzNiN0JPCkhnYXRBUjFUK21iMDZMYzc3eTgya2pYWWdsdnJhNWVzRkY2L1ZpdkFteFRURmlEc21GU0kvVHNDZ1lFQTZldkgKVWp4elpnTDRuaFdyMzFld0ZsV0hjWG5JbFVxNG5zODFPenNhTzdLVlV1NDZEbC82MEYwaGNFUUFIUnRiMFpKegpZaDJHM2ZVbHh2NmR1cXJUb0l0RWxjUTRHSEhyWHg5SkthbUhsZkFGWG9xaHpFTitWM0tBSm1jTHFncnpjeFhTCjFrMW0rUHB4WGZmRWJQMHlIcXRWZFhKOHdoL1J5S2prU3FRUGJ1VUNnWUVBakdmTUgzQURvUFVzQXplZFpGMDUKWGZOWUJNZFVKTWYxNjNseGZaeWZySFlteDhjSi9jWERzdGk4TXdqcWF3ZVpXMXloTC8yUFBlV3lSUHY5bzIrSQpzcG5iSWdZOGxvNFJFaWZpcitQSnpmSWhjVEREeFQ1d2FaVlMrT0lrWkhWdXlYd3ZVWm9YR0xRc21FbUx5eVNWClIyOTFESFVYV0dSMytnaGhESUI0bWRFQ2dZRUFwRzFDdjNDVW9VbEhYei9XZjNqUTR2SWQ4Y3JzRHR6bUoyTjUKaEhnSCtaeVBVQ3I2amk0elRKR2FOcUxsL1kvRW0reTR4R2dDN0RRczZOTURKanA3NWFiZmYvTGNoM3BVTzVudgpRS1RWRkxVUjRTSExsNXg5eTVSRnRqakt2eTFSY1QwTzVlcWtqakRreld1akhBVmlYS0tNd0xESU4yQk1neU1NCnpkYkNybTBDZ1lBanpzaXJ1M290eHJqMnZSWDYrZ2VpdmJpaEhFdDdRRS83aXVOK0oxM0JvTHBLWCtDR0p4eTUKcHZWRzFia3lhVVRaRDF1L0dRcFZTa0YzQkFQcVBBSlFLZHM5c09SclNIM1NDMjV2NWcrQWQrUzlOdFdKTlRCeQoxZVVoVnlwcXVvYW5abm5iRDlEUXh5VGF0TlRRQ3ZWYWpwM1o0aTBJWThZejcvTWl6ZjF6cVE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo"

	_, err := decodePem(input)

	require.Error(t, err)
}
